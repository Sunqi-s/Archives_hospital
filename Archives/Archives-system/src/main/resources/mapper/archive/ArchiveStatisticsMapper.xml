<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.archives.archive.mapper.ArchiveStatisticsMapper">

    <select id="getYeararchiveCount" resultType="com.archives.archive.domain.Statistics">
        SELECT YEAR(ai.create_time) AS year,
            COUNT(*) AS archiveCount,
            ac.name AS category
        FROM archive_info ai
        JOIN archive_category ac ON ai.category_id = ac.id
        WHERE YEAR(ai.create_time) BETWEEN #{startData} AND #{endData}
        GROUP BY YEAR(ai.create_time), ac.name
    </select>
    <select id="getYearfileCount" resultType="com.archives.archive.domain.Statistics">
        SELECT YEAR(ai.create_time) AS year,
            COUNT(CASE WHEN  ai.oss_status = 1 THEN ss.id END) AS fileCount,
            ac.name AS category
        FROM archive_info ai
        LEFT JOIN sys_oss ss on ai.id = ss.fid
        JOIN archive_category ac ON ai.category_id = ac.id
        WHERE YEAR(ai.create_time) BETWEEN #{startData} AND #{endData}
        GROUP BY YEAR(ai.create_time), ac.name
    </select>
    <select id="getYearfileSize" resultType="com.archives.archive.domain.Statistics">
        SELECT YEAR(ai.create_time) AS year,
            SUM(CASE WHEN ai.oss_status = 1 THEN CAST(ss.size AS UNSIGNED) ELSE 0 END) AS totalSize,
            ac.name AS category
        FROM archive_info ai
        LEFT JOIN sys_oss ss on ai.id = ss.fid
        JOIN archive_category ac ON ai.category_id = ac.id
        WHERE YEAR(ai.create_time) BETWEEN #{startData} AND #{endData}
        GROUP BY YEAR(ai.create_time), ac.name
    </select>
    <select id="getStatisticsByCondition" resultType="com.archives.archive.domain.Statistics">
        SELECT
        ai.category_id AS categoryId,
        <choose>
            <when test="condition != null">
                ai.${condition} AS category
            </when>
            <otherwise>
                NULL AS category
            </otherwise>
        </choose>,
        COUNT(*) AS archiveCount,
        COUNT(CASE WHEN ai.oss_status = 1 THEN ss.id END) AS fileCount,
        SUM(CASE WHEN ai.oss_status = 1 THEN CAST(ss.size AS UNSIGNED) ELSE 0 END) AS totalSize
        FROM archive_info ai
        LEFT JOIN sys_oss ss ON ai.id = ss.fid
        WHERE YEAR(ai.create_time) BETWEEN #{startData} AND #{endData}
        <if test="dataCountList != null">
            <foreach collection="dataCountList" item="dataCount" separator="OR">
                AND ai.category_id = #{dataCount}
            </foreach>
        </if>
        GROUP BY ai.category_id, ai.${condition}
    </select>

    <select id="importData" resultType="com.archives.archive.domain.Statistics">
        select
            COUNT(*) as logCount,
            SUM(info_processed_records) as dataCount
        FROM archive_import_log
        WHERE YEAR(create_time) = #{year} AND type in ('dandao','bendi','zaixian')
        GROUP BY DAY(create_time)
        ORDER BY DAY(create_time)
    </select>

    <select id="getCategoryStatistics" resultType="com.archives.archive.domain.Statistics">
        SELECT
        COUNT(*) AS archiveCount,
        COUNT(CASE WHEN  ai.oss_status = 1 THEN ss.id END) AS fileCount,
        SUM(CASE WHEN ai.oss_status = 1 THEN CAST(ss.size AS UNSIGNED) ELSE 0 END) AS totalSize,
        ac.name AS category
        FROM archive_info ai
        LEFT JOIN sys_oss ss on ai.id = ss.fid
        JOIN archive_category ac ON ai.category_id = ac.id
        WHERE YEAR(ai.create_time) BETWEEN #{startData} AND #{endData}
        AND ai.category_id in
        <foreach collection="categoryIds" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>
        GROUP BY ac.name
    </select>

</mapper>